name: "Test"
on:
  pull_request:
  push:
    branches:
      - test

jobs:
  BrowserTest:
    strategy:
      fail-fast: false
      matrix:
        config:
          # - os: ubuntu-latest
          #   name: Linux Firefox Stable
          #   targetBrowser: Firefox_Stable
          #   xvfb: true
          # - os: ubuntu-latest
          #   name: Linux Chrome Stable
          #   targetBrowser: Chrome_Stable
          #   xvfb: true
          # - os: windows-latest
          #   name: Windows Edge Stable
          #   targetBrowser: Edge_Stable
          # - os: macos-latest
          #   name: OSX Safari Stable
          #   targetBrowser: Safari_Stable
          - os: macos-latest
            name: iOS Simulator Safari 16.2
            targetBrowser: Safari_IOS_16_2
          - os: macos-13
            name: iOS Simulator Safari 17
            targetBrowser: Safari_IOS_17
            xcode: /Applications/Xcode_15.0.app
          # - os: macos-latest
          #   name: iOS Simulator Safari 15.0
          #   targetBrowser: Safari_IOS_15_0
          # - os: macos-latest
          #   name: iOS Simulator Safari 13
          #   targetBrowser: Safari_IOS_13
          # - os: macos-latest
          #   name: iOS Simulator Safari 14
          #   targetBrowser: Safari_IOS_14
            # https://stackoverflow.com/questions/51568821/works-in-chrome-but-breaks-in-safari-invalid-regular-expression-invalid-group
          # - os: ubuntu-latest
          #   name: Android Simulator Nexus_5_API_23_x86
          #   targetBrowser: Pixel_7_API_33_x86_64
          #   setupAndroid: true
          # - os: macos-11
          #   name: iOS Simulator Safari 15.0
          #   targetBrowser: Safari_IOS_15_0
          #   xcode: /Applications/Xcode_13.0.app
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.name }}
    env:
      TARGET_BROWSER: ${{ matrix.config.targetBrowser }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: "*"
          check-latest: true
          cache: "npm"
      - name: Install Dependencies
        run: npm ci

      - name: xcode selection
        if: ${{ matrix.config.xcode != '' }}
        # uses: maxim-lobanov/setup-xcode@v1
        # with:
        #   xcode-version: "${{ matrix.config.xcode }}"
        run: sudo xcode-select -s "${{ matrix.config.xcode }}"

      - name: Start Xvfb
        if: ${{ matrix.config.xvfb == true }}
        run: Xvfb :99 &
      - name: Run browser tests
        if: ${{ matrix.config.xvfb == true }}
        run: DISPLAY=:99 npm run karma

      - name: Setup JDK 17
        if: ${{ matrix.config.setupAndroid == true }}
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin
      - name: Setup Android SDK
        if: ${{ matrix.config.setupAndroid == true }}
        uses: amyu/setup-android@v3
      # - name: Set Environment
      #   if: ${{ matrix.config.setupAndroid == true }}
      #   run: |
      #     rc=/tmp/rcfile
      #     echo 'alias adb="$ANDROID_HOME/platform-tools/adb"' > $rc
      #     echo 'alias avdmanager="$ANDROID_HOME/cmdline-tools/bin/avdmanage"' >> $rc
      # - name: Run browser tests
      #   if: ${{ matrix.config.setupAndroid == true }}
      #   run: |
      #     source /tmp/rcfile

      - name: Run browser tests 👩🏽‍💻
        if: ${{ matrix.config.xvfb != true }}
        run: npm run karma
